#!/bin/bash
# post-merge: mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã€supabaseå¤‰æ›´ãŒã‚ã‚Œã°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œ

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# mainãƒ–ãƒ©ãƒ³ãƒã§ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
if [ "$CURRENT_BRANCH" != "main" ]; then
  exit 0
fi

# ãƒãƒ¼ã‚¸å‰å¾Œã§supabase/migrations/ã«å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
# ORIG_HEAD: ãƒãƒ¼ã‚¸å‰ã®HEAD, HEAD: ãƒãƒ¼ã‚¸å¾Œã®HEAD
CHANGED_FILES=$(git diff --name-only ORIG_HEAD HEAD -- 'supabase/migrations/')

if [ -n "$CHANGED_FILES" ]; then
  echo ""
  echo "ğŸ” supabase/migrations/ ã«å¤‰æ›´ã‚’æ¤œå‡º:"
  echo "$CHANGED_FILES" | sed 's/^/   /'
  echo ""

  # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œ
  ./scripts/backup-db.sh

  echo ""
  echo "ğŸ’¡ ãƒªãƒ¢ãƒ¼ãƒˆDBã¸ã®é©ç”¨ã¯æ‰‹å‹•ã§å®Ÿè¡Œã—ã¦ãã ã•ã„:"
  echo "   supabase db push"
else
  echo "â„¹ï¸  supabase/migrations/ ã«å¤‰æ›´ãªã— - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—"
fi
