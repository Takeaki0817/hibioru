# ギャップ分析レポート: streak

## 概要

| 項目 | 状況 |
|------|------|
| 仕様書 | `.kiro/specs/streak/requirements.md`, `design.md`, `tasks.md` |
| 実装 | `src/features/streak/` |
| 分析日 | 2026-01-17 |

## ギャップ一覧

### 1. pg_cronスケジュールコメントの誤り

| 項目 | 内容 |
|------|------|
| 仕様 | コメントに「毎日0:00 JST」と記載 |
| 実装 | 実際のスケジュールは `0 15 * * *`（UTC 15:00 = JST 0:00）で正しい |
| 優先度 | 低 |
| 影響 | ドキュメントの正確性 |

**関連ファイル**: `supabase/migrations/` 内のpg_cron設定

**対応案**: コメントを修正（実装は正しい）

### 2. bonus_hotsure の仕様書未記載

| 項目 | 内容 |
|------|------|
| 仕様 | 記載なし |
| 実装 | `bonus_hotsure` カラムが存在し、ボーナスほつれを管理 |
| 優先度 | 中 |
| 影響 | 仕様書の網羅性 |

**対応案**: 仕様書に `bonus_hotsure` 機能を追記

### 3. 型定義の不整合

| 項目 | 内容 |
|------|------|
| 仕様 | `streak` テーブルに `bonus_hotsure`, `created_at`, `updated_at` |
| 実装 | `src/lib/types/database.ts` にこれらのカラムが未定義 |
| 優先度 | 高 |
| 影響 | 型安全性、コンパイルエラーの可能性 |

**関連ファイル**: `src/lib/types/database.ts`

**対応案**: `pnpm db:types` で型定義を再生成

### 4. テスト未実装

| 項目 | 内容 |
|------|------|
| 仕様 | ユニットテスト・E2Eテスト |
| 実装 | 未実装（削除済み） |
| 優先度 | 高 |
| 影響 | 品質保証 |

## 仕様書更新の必要性

| 項目 | 更新内容 |
|------|---------|
| bonus_hotsure | ボーナスほつれ機能を仕様書に追記 |
| pg_cronコメント | 実装に合わせてコメント修正 |

## テスト観点

### ユニットテスト

- [ ] `calculateStreak`: ストリーク計算ロジック
- [ ] `getStreakData`: データ取得・整形
- [ ] JST日付境界の判定
- [ ] `bonus_hotsure` の加算・消費

### E2Eテスト

- [ ] ストリーク表示（初期状態）
- [ ] 投稿後のストリーク更新
- [ ] 日付をまたいだストリーク継続
- [ ] ストリーク途切れの表示
- [ ] 最長ストリークの記録

## 結論

実装は仕様を満たしているが、**型定義の再生成が必要**。`bonus_hotsure` 機能は仕様書に追記すべき。ストリーク計算ロジックは複雑なため、ユニットテストで網羅的にカバーする。
