# Billing機能 E2Eテストプラン

## 概要
課金機能の包括的なE2Eテスト計画。プラン表示、プラン選択、制限表示、ほつれ購入をカバー。
Stripe Checkoutは外部サービスのため、APIモックでリダイレクト直前までをテスト。

## テストスイート

### 1. プラン表示（BillingSection）(Requirement 1) - 6テスト
| テスト名 | ステップ | 期待結果 | 要件 |
|---------|---------|---------|------|
| 無料プラン表示 | /social プロフィールタブ | 「無料プラン」バッジ表示 | 1-AC1 |
| 投稿残数表示 | 無料ユーザーで表示 | 「今日の投稿: X/15件」 | 1-AC2 |
| 画像残数表示 | 無料ユーザーで表示 | 「今月の画像: X/5枚」 | 1-AC3 |
| プレミアム無制限表示 | プレミアムユーザーで表示 | 残数非表示 | 1-AC4 |
| キャンセル済み期限表示 | キャンセル済みユーザー | 有効期限日表示 | 1-AC5 |
| アップグレードリンク | 無料ユーザーで表示 | /social/plansへのリンク | - |

### 2. プラン選択ページ (Requirement 2) - 7テスト
| テスト名 | ステップ | 期待結果 | 要件 |
|---------|---------|---------|------|
| プランカード表示 | /social/plans アクセス | 月額・年額カード表示 | 2-AC1 |
| 価格・機能表示 | カード確認 | 480円/月、4,200円/年 | 2-AC2 |
| おすすめバッジ | 年額カード確認 | 「おすすめ」表示 | 2-AC3 |
| Checkoutリダイレクト | 月額選択ボタンクリック | Stripe URLへリダイレクト | 2-AC4 |
| ローディング状態 | ボタンクリック中 | ボタン無効化+スピナー | 2-AC5 |
| エラー表示 | API失敗時 | エラーメッセージ | 2-AC6 |
| 戻るボタン | クリック | /social に遷移 | 2-AC7 |

### 3. Stripe Checkout統合 (Requirement 3) - 4テスト
| テスト名 | ステップ | 期待結果 | 要件 |
|---------|---------|---------|------|
| 成功リダイレクト後 | ?checkout=success | 成功メッセージ表示 | 3-AC4 |
| キャンセルリダイレクト | ?checkout=canceled | キャンセルメッセージ | 3-AC5 |
| 既存プレミアムエラー | プレミアムでプラン選択 | エラー「既に加入」 | 3-AC3 |
| 未認証エラー | 未認証でAPI呼び出し | 401エラー | - |

### 4. Customer Portal (Requirement 4) - 3テスト
| テスト名 | ステップ | 期待結果 | 要件 |
|---------|---------|---------|------|
| 管理ボタン表示 | プレミアムで/social | 「プラン・お支払いを管理」表示 | 4-AC1 |
| ポータルリダイレクト | 管理ボタンクリック | Stripe Portal URLへ | 4-AC1 |
| 顧客不在エラー | stripe_customer_idなし | エラー表示 | 4-AC2 |

### 5. 使用制限管理 (Requirement 6) - 5テスト
| テスト名 | ステップ | 期待結果 | 要件 |
|---------|---------|---------|------|
| 制限API正常 | /api/billing/limits | planType, 制限情報返却 | 6-AC7 |
| 無料投稿制限 | 15件投稿後 | 投稿不可 | 6-AC1,2 |
| 無料画像制限 | 5枚添付後 | 画像添付不可 | 6-AC3,4 |
| プレミアム無制限 | プレミアムで投稿 | 制限なし | 6-AC5 |
| JST日次リセット | 日付跨ぎ | 投稿カウントリセット | 6-AC6 |

### 6. ほつれパック購入 (Requirement 7) - 5テスト
| テスト名 | ステップ | 期待結果 | 要件 |
|---------|---------|---------|------|
| 購入ボタン表示 | BillingSection確認 | 「ほつれを追加購入」表示 | 7-AC1 |
| 価格表示 | BillingSection確認 | 「2回分 ¥120」 | - |
| 購入Checkoutリダイレクト | 購入ボタンクリック | Stripe URLへ | 7-AC1 |
| 成功リダイレクト | ?hotsure_purchase=success | 成功メッセージ | 7-AC5 |
| キャンセルリダイレクト | ?hotsure_purchase=canceled | キャンセルメッセージ | 7-AC6 |

### 7. エラーハンドリング (Requirement 8) - 1テスト
| テスト名 | ステップ | 期待結果 | 要件 |
|---------|---------|---------|------|
| 未認証エラー | 未認証でServer Action | UNAUTHORIZEDエラー | 8-AC1,2 |

### 8. レスポンシブデザイン - 3テスト
| テスト名 | ステップ | 期待結果 | 要件 |
|---------|---------|---------|------|
| モバイル表示 | 375px幅 | カード縦並び | - |
| タブレット表示 | 768px幅 | カード横並び | - |
| デスクトップ表示 | 1280px幅 | 正常表示 | - |

## 合計: 34テストケース

## 注意事項
- Stripe Checkoutへの実際のリダイレクトはテスト不可（外部サービス）
- `page.route()`でAPIモックして応答を制御
- Webhookは統合テストで別途実施
- プレミアム/無料のテストには異なるセッション設定が必要
