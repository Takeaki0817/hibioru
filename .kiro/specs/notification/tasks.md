# Implementation Plan

## Tasks

- [x] 1. データベース基盤の構築
- [x] 1.1 通知関連テーブルのマイグレーション作成
  - push_subscriptionsテーブル（購読情報、複数デバイス対応）を作成
  - notification_settingsテーブル（通知設定、制約チェック付き）を作成
  - notification_logsテーブル（送信ログ、インデックス付き）を作成
  - 外部キー制約とRLSポリシーを設定
  - updated_at自動更新トリガーを追加
  - _Requirements: 1.1, 2.1, 3.3, 6.1, 6.2_

- [ ] 2. VAPID鍵とプロジェクト設定
- [ ] 2.1 (P) VAPID鍵生成スクリプトの作成
  - web-pushライブラリを使用した鍵生成スクリプトを作成
  - 環境変数の設定方法をスクリプト内にコメントで記載
  - _Requirements: 1.1_

- [ ] 2.2 (P) 環境変数と設定ファイルの整備
  - VAPID公開鍵をクライアント用環境変数として設定
  - VAPID秘密鍵をサーバー用環境変数として設定
  - Supabase Service Role Keyの設定を確認
  - _Requirements: 1.1, 5.4_

- [ ] 3. 購読管理サービスの実装
- [ ] 3.1 購読情報の登録・取得・削除ロジック
  - ユーザーごとの購読情報をデータベースに保存する機能を実装
  - 複数デバイスの購読情報を管理（同一ユーザーで複数エンドポイント）
  - 購読解除時に該当デバイスの情報を削除
  - 重複エンドポイントの検出と適切なエラーハンドリング
  - _Requirements: 1.1, 1.2, 1.3, 1.5_

- [ ] 3.2 無効エンドポイントの自動削除処理
  - 410 Gone応答を受け取った購読情報を自動削除
  - 削除ログの記録
  - _Requirements: 5.3_

- [x] 4. 通知設定サービスの実装
- [x] 4.1 設定の取得・更新・デフォルト適用ロジック
  - ユーザーの通知設定を取得する機能を実装
  - 設定変更を即時反映（enabled、primaryTime、timezone、followUp関連、activeDays）
  - 新規ユーザー登録時にデフォルト設定を自動適用
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 4.2 設定値のバリデーション
  - primaryTimeの範囲チェック（00:00-23:59）
  - followUpIntervalMinutesの範囲チェック（15-180分）
  - followUpMaxCountの範囲チェック（1-3回）
  - activeDaysの形式検証（0-6の配列）
  - _Requirements: 2.4, 2.5, 2.6, 2.7_

- [ ] 5. 通知メッセージサービスの実装
- [ ] 5.1 (P) 通知文言の生成ロジック
  - メインリマインド用の文言バリエーション（「今日はどんな一日だった？」「一言だけでも残しておこう」）
  - 追いリマインド1回目用の文言（「まだ間に合うよ」「30秒で終わる」）
  - 追いリマインド2回目用の文言（「今日の最後のチャンス」「ほつれ使う？」）
  - ランダム選択ロジックの実装
  - _Requirements: 3.2, 4.2, 4.3_

- [ ] 6. 通知ログサービスの実装
- [ ] 6.1 送信ログの記録機能
  - 通知送信時のログ記録（user_id、type、sent_at、result）
  - 成功・失敗・スキップの各結果を記録
  - エラーメッセージの保存
  - _Requirements: 3.3, 3.5, 4.5_

- [ ] 6.2 記録追跡機能の実装
  - 通知後のエントリー作成時刻（entry_recorded_at）を更新
  - 応答時間（通知送信から記録作成まで）の計算準備
  - _Requirements: 6.1, 6.2_

- [ ] 6.3 (P) ログクリーンアップ機能
  - 90日経過したログの削除ロジック
  - pg_cronジョブとして毎日実行するSQL設定
  - _Requirements: 6.3_

- [ ] 7. 通知配信サービスの実装
- [ ] 7.1 通知送信処理の実装
  - web-pushライブラリを使用した通知送信
  - 全登録デバイスへの一斉送信
  - 送信結果の収集と返却
  - _Requirements: 5.2_

- [ ] 7.2 タイムゾーン対応の配信時刻計算
  - ユーザーごとのtimezoneに基づくローカル時刻計算
  - primaryTimeとの照合ロジック
  - activeDays（曜日）との照合
  - _Requirements: 5.1_

- [ ] 7.3 記録済みユーザーのスキップ判定
  - 当日のエントリー存在確認
  - 記録済みの場合は通知をスキップしてログに記録
  - _Requirements: 3.4_

- [ ] 8. 追いリマインドスケジューラの実装
- [ ] 8.1 追いリマインドのスケジュール計算
  - primaryTime後の追いリマインド送信時刻を計算
  - followUpIntervalMinutesに基づくインターバル計算
  - followUpMaxCountに基づく送信回数制限
  - _Requirements: 4.1, 4.6_

- [ ] 8.2 記録完了時のキャンセル処理
  - ユーザーが記録を完了した際に予定された追いリマインドをキャンセル
  - キャンセル状態の管理
  - _Requirements: 4.4_

- [ ] 9. API エンドポイントの実装
- [ ] 9.1 購読登録APIの実装
  - POSTエンドポイントで購読情報を受け取り保存
  - 認証済みユーザーの検証
  - 重複登録時のエラーハンドリング
  - 登録失敗時の再試行促進メッセージ
  - _Requirements: 1.1, 1.2, 1.5_

- [ ] 9.2 (P) 購読解除APIの実装
  - DELETEエンドポイントで購読情報を削除
  - 該当デバイスのみ削除（他デバイスは維持）
  - _Requirements: 1.3_

- [x] 9.3 (P) 通知設定APIの実装
  - GET/PUTエンドポイントで設定の取得・更新
  - バリデーションエラーの詳細レスポンス
  - 即時反映の確認
  - _Requirements: 2.1, 2.2_

- [ ] 10. Service Workerの実装
- [ ] 10.1 プッシュ通知受信ハンドラ
  - pushイベントで通知内容を解析して表示
  - アプリアイコンとバッジの設定
  - 通知データ（URL、タイプ）の受け渡し
  - _Requirements: 5.5_

- [ ] 10.2 通知クリックハンドラ
  - クリック時にアプリ画面（記録入力画面）を開く
  - 既存ウィンドウがあればフォーカス
  - 新規ウィンドウを開く場合のURL指定
  - _Requirements: 5.5_

- [ ] 11. Edge Functionの実装
- [ ] 11.1 通知配信Edge Functionの作成
  - 現在時刻から配信対象ユーザーを特定
  - timezone考慮したprimaryTime判定
  - メインリマインドと追いリマインドの両方に対応
  - 同一分内の重複実行をスキップ
  - _Requirements: 3.1, 4.1, 5.1, 5.4_

- [ ] 11.2 pg_cronジョブの設定
  - 毎分実行のcronジョブ登録
  - Edge Functionを呼び出すHTTPリクエスト設定
  - Service Role Keyによる認証設定
  - _Requirements: 5.4_

- [x] 12. 通知設定UIの実装
- [x] 12.1 通知許可とブラウザ対応判定
  - ブラウザの通知サポート判定
  - 非対応時の通知機能無効化と説明メッセージ表示
  - 通知許可リクエストの実行
  - 許可状態の表示
  - _Requirements: 1.4_

- [x] 12.2 通知設定フォームの実装
  - 通知有効/無効の切り替え
  - primaryTime（通知時刻）の設定
  - timezoneの選択
  - followUp設定（有効/無効、間隔、最大回数）
  - activeDays（曜日）の選択
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7_

- [x] 12.3 設定保存とエラーハンドリング
  - オプティミスティック更新とロールバック
  - バリデーションエラーの表示
  - 保存成功時のフィードバック
  - _Requirements: 2.2_

- [ ] 13. 統合とエントリー連携
- [ ] 13.1 エントリー作成時の通知ログ更新
  - 新規エントリー作成時に当日の通知ログのentry_recorded_atを更新
  - 追いリマインドのキャンセル処理をトリガー
  - _Requirements: 4.4, 6.1_

- [x] 13.2 新規ユーザー登録時のデフォルト設定作成
  - ユーザー登録フローに通知設定の初期化を統合
  - デフォルト値の適用
  - _Requirements: 2.3_

- [ ] 14. 動作検証
- [ ] 14.1 通知フロー全体の統合テスト
  - 購読登録から通知受信までのエンドツーエンドフロー
  - メインリマインドの配信確認
  - 追いリマインドの段階的送信確認
  - 記録完了時のスキップ確認
  - _Requirements: 1.1, 3.1, 4.1, 4.4_

- [ ]* 14.2 バリデーションとエラーケースのテスト
  - 設定値の範囲チェック検証
  - 無効エンドポイントの自動削除検証
  - 通知非対応ブラウザでの動作確認
  - _Requirements: 1.4, 2.4, 2.5, 2.6, 2.7, 5.3_
