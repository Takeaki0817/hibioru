# Implementation Plan

## 概要

本実装計画は、ヒビオル（hibioru）アプリケーションにGoogle OAuth認証機能を追加するためのタスクを定義する。Supabase Authを活用し、ADHD当事者にとってストレスフリーな認証体験を実現する。

---

## タスク

- [x] 1. 環境設定とSupabaseクライアント基盤の構築
- [x] 1.1 (P) ブラウザ用Supabaseクライアントの作成
  - シングルトンパターンでクライアントインスタンスを管理する機能を実装
  - 環境変数（NEXT_PUBLIC_SUPABASE_URL、NEXT_PUBLIC_SUPABASE_ANON_KEY）からの設定読み込み
  - Database型を使用した型安全なクライアント生成
  - 環境変数未設定時の明確なエラーメッセージ表示
  - _Requirements: 4.4_

- [x] 1.2 (P) サーバー用Supabaseクライアントの作成
  - Cookie操作対応のサーバーサイドクライアント生成機能を実装
  - Server Components、Route Handlers、Server Actions、Middlewareでの使用を想定
  - cookies()関数を使用したCookieの読み書きハンドリング
  - Cookie操作時のエラーハンドリング
  - _Requirements: 4.4_

- [x] 1.3 (P) TypeScript型定義の作成
  - データベーススキーマに対応するDatabase型インターフェースの定義
  - User型、AuthError型など認証ドメインの型定義
  - usersテーブルのRow、Insert、Update型の定義
  - _Requirements: 3.1_

- [x] 2. データベース設定
- [x] 2.1 usersテーブルとRLSポリシーの作成
  - ユーザー情報を永続化するusersテーブルのマイグレーション作成
  - id（UUID、auth.usersへの外部キー）、email（ユニーク）、display_name、avatar_url、created_atカラムの定義
  - Row Level Securityの有効化
  - ユーザーが自分のデータのみ読み取り可能なポリシーの設定
  - _Requirements: 3.1, 3.5_

- [x] 2.2 新規ユーザー作成トリガーの実装
  - auth.usersへの挿入時に自動的にpublic.usersにレコードを作成するトリガー関数の作成
  - Googleアカウントからemail、display_name（full_name）、avatar_urlを取得して保存
  - SECURITY DEFINERによる安全なデータ挿入
  - _Requirements: 1.3, 1.4, 3.2, 3.3, 3.4_

- [x] 3. 認証コールバックとミドルウェアの実装
- [x] 3.1 OAuth認証コールバックハンドラーの作成
  - PKCEフローの認証コードをセッションに交換するRoute Handler実装
  - 認証成功時のメインタイムライン画面へのリダイレクト
  - 認証キャンセル時のログイン画面への静かなリダイレクト（エラーメッセージなし）
  - 認証エラー時の適切なエラーハンドリング
  - _Requirements: 1.2, 1.5, 6.1_

- [x] 3.2 ルート保護ミドルウェアの実装
  - すべてのリクエストで認証トークンを検証する機能
  - getUser()による毎リクエストのトークン検証（getSession()は使用しない）
  - 未認証ユーザーのログイン画面へのリダイレクト
  - 認証済みユーザーがログイン画面にアクセスした場合のタイムラインへのリダイレクト
  - リダイレクト元URLの保存と認証後の復元
  - トークンリフレッシュとCookieへの設定
  - matcherによる対象パスの限定（パフォーマンス考慮）
  - _Requirements: 4.1, 4.2, 4.3, 7.1, 7.2, 7.3_

- [x] 4. 認証アクションとプロバイダーの実装
- [x] 4.1 認証アクションの作成
  - Google OAuth認証フローを開始するsignInWithGoogle関数の実装
  - リダイレクトURLの動的生成（環境変数管理）
  - ログアウト処理（セッション終了、ローカル認証情報クリア、ログイン画面へのリダイレクト）
  - _Requirements: 1.1, 5.1, 5.2, 5.3_

- [x] 4.2 認証状態プロバイダーの作成
  - アプリケーション全体で認証状態を共有するContextの実装
  - onAuthStateChangeによる認証状態変更のリスニング
  - 認証済みユーザー情報（id、email、displayName、avatarUrl）の提供
  - useAuthフックによるContext値へのアクセス
  - SSRとCSRの状態不整合対策（初期ロード時isLoading=true）
  - _Requirements: 4.1_

- [x] 5. ログイン画面UIの実装
- [x] 5.1 Googleログインボタンコンポーネントの作成
  - Googleブランドガイドラインに準拠したボタンデザイン
  - Googleロゴと「Googleでログイン」テキストの表示
  - ローディング状態の視覚的フィードバック
  - アクセシビリティ対応（aria-label、フォーカス状態）
  - Tailwind CSSによるスタイリング
  - _Requirements: 2.1, 2.3_

- [x] 5.2 ログインページの作成
  - サービス名「ヒビオル」とシンプルなキャッチコピーの表示
  - Googleログインボタンのみを配置したミニマルなUI
  - 2タップ以内でログイン完了できる導線設計
  - ローディング状態の管理と表示
  - ボタン連打防止（ローディング中はdisabled）
  - リダイレクトモードによるGoogleポップアップブロック対策
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 6. エラーハンドリングの実装
- [x] 6.1 認証エラーの分類とメッセージング
  - エラー種別の判定ロジック（network、auth、unknown）
  - ネットワークエラー時の「接続を確認して再試行」メッセージ
  - 認証エラー時の「もう一度お試しください」メッセージ
  - 予期せぬエラー時の「しばらくしてからお試しください」メッセージ
  - 認証キャンセル時はメッセージを表示しない
  - _Requirements: 6.1, 6.2_

- [x] 6.2 エラー状態の回復機能
  - エラー発生後も再試行可能な状態を維持
  - 再試行ボタンの表示
  - アプリがクラッシュしないグレースフルな処理
  - _Requirements: 6.3, 6.4_

- [x] 7. 統合とルートレイアウトの設定
- [x] 7.1 ルートレイアウトへのAuthProvider組み込み
  - RootLayoutでAuthProviderをラップし全ページで認証状態を利用可能に
  - Client Componentとしての適切な設定
  - セッション更新のハンドリング
  - _Requirements: 4.1_

- [x] 7.2 認証フロー全体の結合テスト
  - ログインボタンクリックからGoogleログイン画面リダイレクトまでの確認
  - Google認証完了後のコールバック処理とタイムラインへのリダイレクト
  - 初回ログイン時のusersテーブルへの新規レコード作成確認
  - 既存ユーザーでのログイン時の既存レコードとの紐付け確認
  - ログアウト後の認証情報クリアとログイン画面へのリダイレクト
  - 未認証での保護ページアクセス時のリダイレクト動作
  - 認証後の元ページへのリダイレクト復元
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 5.1, 5.2, 5.3, 7.1, 7.3_

---

## 要件カバレッジ

| 要件ID | タスク |
|--------|--------|
| 1.1 | 4.1, 7.2 |
| 1.2 | 3.1, 7.2 |
| 1.3 | 2.2, 7.2 |
| 1.4 | 2.2, 7.2 |
| 1.5 | 3.1 |
| 2.1 | 5.1, 5.2 |
| 2.2 | 5.2 |
| 2.3 | 5.1, 5.2 |
| 2.4 | 5.2 |
| 3.1 | 1.3, 2.1 |
| 3.2 | 2.2 |
| 3.3 | 2.2 |
| 3.4 | 2.2 |
| 3.5 | 2.1 |
| 4.1 | 3.2, 4.2, 7.1 |
| 4.2 | 3.2 |
| 4.3 | 3.2 |
| 4.4 | 1.1, 1.2 |
| 5.1 | 4.1, 7.2 |
| 5.2 | 4.1, 7.2 |
| 5.3 | 4.1, 7.2 |
| 6.1 | 3.1, 6.1 |
| 6.2 | 6.1 |
| 6.3 | 6.2 |
| 6.4 | 6.2 |
| 7.1 | 3.2, 7.2 |
| 7.2 | 3.2 |
| 7.3 | 3.2, 7.2 |
