# Implementation Plan

## タイムライン/カレンダーページ実装タスク

### データ層・Hooks

- [ ] 1. データ取得基盤の構築
- [ ] 1.1 (P) 投稿データの無限スクロール取得機能を実装する
  - TanStack Queryを使用した投稿データのページネーション取得処理を構築する
  - カーソルベースのページネーション（created_at基準）で前後のデータを取得できるようにする
  - 投稿のない日を自動的にスキップするクエリロジックを実装する
  - エラー状態の管理とリトライ機能を提供する
  - _Requirements: 2.1, 2.2, 2.4, 4.1, 7.3_

- [ ] 1.2 (P) カレンダー表示用の記録状況データ取得機能を実装する
  - 指定月の記録日一覧を取得する処理を構築する
  - 連続記録日（ストリーク）の算出ロジックを実装する
  - ほつれ使用日の取得処理を追加する
  - 月をまたぐ連続記録の判定のため前月最終日も含めて取得する
  - _Requirements: 4.2, 6.1, 6.2, 6.3_

### ジェスチャー・同期Hooks

- [ ] 2. ユーザー操作・同期機能の構築
- [ ] 2.1 (P) スワイプジェスチャーによる日付ナビゲーション機能を実装する
  - react-swipeableを使用した左右スワイプの検出処理を構築する
  - スワイプ感度の調整（最小距離、最大時間）を設定可能にする
  - タッチデバイスとマウスの両方に対応する
  - 垂直スクロールとの干渉を防ぐ設定を行う
  - _Requirements: 1.1, 1.2_

- [ ] 2.2 スクロール位置と日付ヘッダーの双方向同期機能を実装する
  - 現在表示中の投稿から日付を算出する処理を構築する
  - 日付境界でのスナップスクロール実行機能を実装する
  - 外部からの日付指定によるスクロール位置移動機能を追加する
  - Intersection Observerを使用した日付境界検出を行う
  - requestAnimationFrameによるスクロールイベントのデバウンス処理を実装する
  - _Requirements: 2.3, 3.1, 3.2_
  - _Contracts: useScrollSync (useTimelineからのentries依存)_

### UIコンポーネント - 投稿表示

- [ ] 3. 投稿カードと一覧表示の構築
- [ ] 3.1 個別投稿の表示と操作機能を実装する
  - 投稿内容（テキスト、画像）を表示するカードコンポーネントを構築する
  - タップで編集ページ（/edit/[id]）へ遷移する機能を実装する
  - 長押し（500ms閾値）でコンテキストメニューを表示する機能を追加する
  - タップと長押しの誤認識を防ぐタイマーベースの判定を実装する
  - _Requirements: 5.1, 5.2_

- [ ] 3.2 長押し時のアクションメニュー表示機能を実装する
  - メニューオプション（編集、削除等）を表示するオーバーレイを構築する
  - 背景タップでメニューを閉じる機能を実装する
  - キーボードナビゲーションによるアクセシビリティ対応を行う
  - モバイルでの位置調整（ビューポート内に収まる制御）を実装する
  - _Requirements: 5.2_

- [ ] 3.3 投稿一覧の仮想スクロール表示機能を実装する
  - TanStack Virtualを使用した仮想スクロールを構築する
  - 動的行高さ（画像読み込み対応）のmeasureElement計測を実装する
  - 日付境界でのスナップアニメーション連携を行う
  - エラー時のリトライUI表示機能を追加する
  - 1.1, 2.2で構築したHooksを統合する
  - _Requirements: 2.1, 2.2, 2.3, 4.1, 7.2, 7.3_
  - _Contracts: TimelineList (useTimeline, useScrollSync依存)_

### UIコンポーネント - ナビゲーション

- [ ] 4. 日付ナビゲーションとカレンダーの構築
- [ ] 4.1 日付ヘッダーの表示とナビゲーション機能を実装する
  - 現在表示中の日付を「YYYY年MM月DD日（曜日）」形式で表示する
  - スワイプジェスチャーによる前後日移動を統合する（2.1のHooks使用）
  - カレンダーアイコンタップで月カレンダー展開/閉じる制御を実装する
  - ほつれ使用日に絵文字マーク表示機能を追加する
  - スクロール同期による日付自動更新を統合する（2.2のHooks使用）
  - _Requirements: 1.1, 1.2, 1.3, 3.1, 3.2, 4.2_
  - _Contracts: DateHeader (useSwipeNavigation, useScrollSync依存)_

- [ ] 4.2 月単位のカレンダー表示と記録状況の可視化機能を実装する
  - react-day-pickerを使用した月カレンダーグリッドを表示する
  - カスタムレンダラーで記録日に丸マーク、連続記録日に継続線を表示する
  - ほつれ使用日に絵文字マーク、今日を二重丸で強調表示する
  - 日付タップで該当位置へスクロールする機能を実装する（2.2のHooks使用）
  - カレンダー外タップで閉じる機能を追加する
  - 1.2で構築したカレンダーデータ取得Hooksを統合する
  - _Requirements: 1.4, 6.1, 6.2, 6.3, 6.4, 6.5_
  - _Contracts: MonthCalendar (useCalendarData, useScrollSync依存)_

### ページ統合

- [ ] 5. メインページの構築と全体統合
- [ ] 5.1 タイムラインページのサーバーコンポーネントを構築する
  - Server Componentで今日の投稿を初期データとしてフェッチする
  - 初期データをClient ComponentへpropsとしてHydrationする
  - 今日の最終投稿位置を初期表示位置として設定する
  - _Requirements: 2.4_
  - _Contracts: TimelinePage (Server Component)_

- [ ] 5.2 全コンポーネントを統合してタイムラインページを完成させる
  - DateHeader、MonthCalendar、TimelineListを配置・連携させる
  - モバイルとデスクトップの両方で適切に表示されるレスポンシブレイアウトを実装する
  - 画面サイズに応じたカレンダー表示位置の調整を行う
  - 全体的なスタイリングと余白調整を完了する
  - _Requirements: 7.1_

### 品質保証

- [ ] 6. 統合テストと動作検証
- [ ] 6.1 主要機能の統合テストを実施する
  - 初期ロードで今日の最終投稿が表示されることを確認する
  - スクロール時に日付ヘッダーが同期更新されることを確認する
  - カレンダーで日付選択時にスクロール位置が移動することを確認する
  - 無限スクロールで追加データが取得されることを確認する
  - _Requirements: 2.4, 3.1, 3.2, 1.4, 2.2_

- [ ] 6.2 エッジケースとパフォーマンスの検証を実施する
  - 投稿が0件の状態での空状態UI表示を確認する
  - ネットワークエラー時のリトライ機能動作を確認する
  - 大量投稿（1000件以上）での仮想スクロール性能を検証する
  - 連続スクロール時のメモリ使用量を監視する
  - _Requirements: 7.2, 7.3_
