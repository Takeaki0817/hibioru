# Implementation Plan

## Tasks

- [x] 1. データベーススキーマとRLSポリシーの設定
- [x] 1.1 通知設定テーブルの作成
  - ユーザーごとの通知有効/無効フラグとリマインド時刻を保存するテーブルを作成する
  - 外部キー制約とCASCADE削除を設定する
  - デフォルト値（enabled: false）を設定する
  - _Requirements: 4.2, 4.3_

- [x] 1.2 通知設定テーブルのRLSポリシー設定
  - SELECT/UPDATE/INSERTに対してユーザー本人のみアクセス可能なポリシーを設定する
  - auth.uid()によるアクセス制御を実装する
  - _Requirements: 7.2, 7.3_

- [x] 2. 認証基盤とアクセス制御の実装
- [x] 2.1 マイページのサーバーサイド認証検証
  - Server Componentでユーザー認証状態を検証する機能を実装する
  - Supabase AuthのgetUser()を使用してセッション有効性を検証する（getSession()は使用禁止）
  - 未認証ユーザーをログインページにリダイレクトする処理を実装する
  - _Requirements: 7.1_

- [x] 2.2 ユーザー固有データアクセス制御の実装
  - 認証済みユーザーのIDに基づいてデータを取得する仕組みを実装する
  - 他ユーザーのデータにアクセスできないことを保証する
  - _Requirements: 7.2, 7.3_

- [x] 3. プロフィール表示機能の実装
  - Supabase Authのuser_metadataからアバターURLと表示名を取得して表示する
  - アバター未設定時にデフォルトアバター画像を表示する
  - Google OAuthで取得したプロフィール情報を適切に表示する
  - モバイル/タブレット/デスクトップに対応したレスポンシブレイアウトを実装する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 8.1_

- [x] 4. ストリーク・ほつれ統計表示機能の実装
- [x] 4.1 (P) ストリーク表示コンポーネントの実装
  - 現在の継続記録を火のアイコンと共に表示する
  - 過去最長の継続記録をトロフィーアイコンと共に表示する
  - ストリークを「失いたくない資産」として視覚的に強調するスタイルを適用する
  - 現在のストリークが最長記録と一致する場合に特別な視覚表示を行う
  - ストリークが0日の場合に励ましメッセージを表示する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 4.2 (P) ほつれ残り表示コンポーネントの実装
  - 残りほつれ回数を糸アイコンと共に表示する
  - 最大値（週2回）に対する残り回数を表示する
  - ほつれ残り0の場合に警告スタイルを適用する
  - ほつれ残り1の場合に注意喚起スタイルを適用する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 4.3 統計セクションの統合と配置
  - ストリーク表示とほつれ表示を統合したセクションを構成する
  - Server Componentから統計データを子コンポーネントにpropsで渡す
  - レスポンシブレイアウトを適用する
  - _Requirements: 8.1_

- [x] 5. 通知設定機能の実装
- [x] 5.1 ブラウザ通知サポート検出機能の実装
  - ブラウザがWeb Push APIをサポートしているか検出する
  - 非対応ブラウザに対して適切なメッセージを表示する
  - _Requirements: 4.4_

- [x] 5.2 通知許可状態の管理と表示
  - 現在の通知許可状態（granted/denied/default）を取得して表示する
  - 通知が拒否されている場合にブラウザ設定からの許可が必要である旨を案内する
  - _Requirements: 4.1, 4.5_

- [x] 5.3 通知設定の切り替え機能の実装
  - 通知のオン/オフを切り替えるトグルUIを実装する
  - ユーザー操作時にNotification.requestPermission()を呼び出す
  - 設定変更をデータベースに保存する
  - 楽観的更新と失敗時のロールバックを実装する
  - 設定変更を即時に反映する
  - _Requirements: 4.2, 4.6_

- [x] 5.4 リマインド時刻設定機能の実装
  - 通知有効時にリマインド時刻を設定できるUIを提供する
  - 時刻設定をデータベースに保存する
  - _Requirements: 4.3_

- [x] 6. データエクスポート機能の実装
- [x] 6.1 エクスポートAPIエンドポイントの実装
  - GET /api/exportエンドポイントを作成する
  - 認証済みユーザーのエントリーデータを取得する
  - 期間指定（from/to）によるフィルタリングを実装する
  - JSON形式でのデータシリアライズを実装する
  - Markdown形式でのデータシリアライズを実装する
  - 適切なContent-Dispositionヘッダーを設定し、日付を含むファイル名を付与する
  - データが存在しない場合に404エラーを返す
  - _Requirements: 5.2, 5.3, 5.4, 5.7, 5.8_

- [x] 6.2 エクスポートUIの実装
  - エクスポート形式（JSON/Markdown）の選択UIを提供する
  - 期間指定（開始日・終了日）の入力UIを提供する
  - 日付範囲の妥当性チェック（from <= to）を実装する
  - _Requirements: 5.1, 5.4_

- [x] 6.3 エクスポート実行とダウンロード処理の実装
  - ローディング状態の表示を実装する
  - fetch APIでBlobとしてデータを受信する
  - URL.createObjectURLを使用してダウンロードを開始する
  - エクスポート対象データがない場合のメッセージ表示を実装する
  - _Requirements: 5.5, 5.6, 5.7_

- [x] 7. ログアウト機能の実装
- [x] 7.1 確認ダイアログコンポーネントの実装
  - モーダル形式の確認ダイアログを作成する
  - 確定/キャンセルアクションを提供する
  - ローディング状態の表示に対応する
  - フォーカス管理とEscキーによるクローズを実装する
  - _Requirements: 6.1_

- [x] 7.2 ログアウト処理の実装
  - ログアウトボタンタップ時に確認ダイアログを表示する
  - Supabase AuthのsignOut（scope: local）を実行する
  - ローカルストレージのセッション情報をクリアする
  - ログアウト完了後にログインページへリダイレクトする
  - 処理中の重複クリック防止を実装する
  - エラー発生時のメッセージ表示と再試行促進を実装する
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 8. マイページ統合とレスポンシブ対応
- [x] 8.1 マイページ全体のレイアウト構成
  - プロフィール、統計、設定、エクスポート、ログアウトの各セクションを配置する
  - Server Componentとして認証・データ取得後、子コンポーネントへpropsを渡す
  - _Requirements: 7.1, 7.2_

- [x] 8.2 レスポンシブデザインの最終調整
  - モバイル、タブレット、デスクトップの各画面サイズでレイアウトを検証・調整する
  - タッチ操作とマウス操作の両方に対応する
  - PWAとしてホーム画面から起動した際の動作を確認する
  - _Requirements: 8.1, 8.2, 8.3_

- [x] 9. 統合テストとエラーハンドリング
- [x] 9.1 認証フローの統合テスト
  - 認証済みユーザーのマイページアクセス成功を検証する
  - 未認証ユーザーのリダイレクト動作を検証する
  - _Requirements: 7.1, 7.2, 7.3_

- [x] 9.2 主要機能の統合テスト
  - エクスポートAPIの認証・データ返却を検証する
  - ログアウト後のセッションクリアを検証する
  - 通知設定の保存・読み込みを検証する
  - _Requirements: 4.1, 4.2, 5.2, 5.3, 6.2, 6.4_
