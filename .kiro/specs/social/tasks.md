# Implementation Plan

## ソーシャル機能実装タスク

> **Note**: このドキュメントは既存実装のドキュメント化です。全タスクは実装済みです。

### データ層

- [x] 1. データベース基盤の構築
- [x] 1.1 ソーシャル関連テーブルを作成する
  - `follows`テーブル（フォロー関係）を作成する
  - `achievements`テーブル（達成イベント）を作成する
  - `celebrations`テーブル（お祝い）を作成する
  - `social_notifications`テーブル（ソーシャル通知）を作成する
  - _Requirements: 2.1, 4.3, 5.4, 6.1, 6.2_

- [x] 1.2 既存テーブルを拡張する
  - `entries.is_shared`カラムを追加する
  - `notification_settings.social_notifications_enabled`カラムを追加する
  - 共有投稿用のインデックスを作成する
  - _Requirements: 1.1, 6.7_

- [x] 1.3 Supabase Realtimeを有効化する
  - `achievements`テーブルのRealtime設定を追加する
  - `celebrations`テーブルのRealtime設定を追加する
  - `social_notifications`テーブルのRealtime設定を追加する
  - `follows`テーブルのRealtime設定を追加する
  - _Requirements: 3.4_

- [x] 1.4 RLSポリシーを設定する
  - フォロー中ユーザーの達成のみ閲覧可能なポリシーを作成する
  - フォロー中ユーザーの共有投稿のみ閲覧可能なポリシーを作成する
  - 自分の通知のみ閲覧可能なポリシーを作成する
  - _Requirements: 2.6, 5.6_

### API層

- [x] 2. Server Actionsの実装
- [x] 2.1 フォロー機能APIを実装する
  - `followUser`関数（フォロー）を実装する
  - `unfollowUser`関数（アンフォロー）を実装する
  - `getFollowCounts`関数（フォロー数取得）を実装する
  - `getFollowingList`関数（フォロー中一覧）を実装する
  - `getFollowerList`関数（フォロワー一覧）を実装する
  - 自己フォロー禁止、重複フォロー禁止のバリデーションを実装する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 2.2 達成機能APIを実装する
  - `checkAndCreateAchievements`関数を実装する
  - 4種類の達成タイプ（daily_posts, total_posts, streak_days, shared_entry）をサポートする
  - 閾値チェックロジックを実装する
  - 重複達成防止ロジックを実装する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 2.3 お祝い機能APIを実装する
  - `celebrateAchievement`関数（お祝い送信）を実装する
  - `uncelebrateAchievement`関数（お祝い取消）を実装する
  - 重複お祝い禁止のバリデーションを実装する
  - _Requirements: 5.1, 5.3, 5.4_

- [x] 2.4 通知機能APIを実装する
  - `getSocialNotifications`関数（通知一覧取得）を実装する
  - `markAsRead`関数（既読マーク）を実装する
  - `markAllAsRead`関数（全既読）を実装する
  - `getUnreadCount`関数（未読数取得）を実装する
  - お祝い通知・フォロー通知の作成処理を実装する
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 2.5 プロフィール機能APIを実装する
  - `getMyProfile`関数（プロフィール取得）を実装する
  - `updateProfile`関数（プロフィール更新）を実装する
  - `checkUsernameAvailability`関数（ユーザー名重複チェック）を実装する
  - ユーザー名バリデーション（3〜20文字、英数字+アンダースコア）を実装する
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 2.6 タイムライン機能APIを実装する
  - `getSocialFeed`関数（ソーシャルフィード取得）を実装する
  - フォロー中ユーザーの達成・共有投稿を取得するクエリを実装する
  - カーソルベースのページネーション（20件/ページ）を実装する
  - フォロー前の達成は各ユーザーにつき最新1件のみ表示するフィルタリングを実装する
  - _Requirements: 3.1, 3.2, 3.3, 3.5_

- [x] 2.7 ユーザー検索APIを実装する
  - `searchUsers`関数を実装する
  - ユーザー名での前方一致検索を実装する
  - 検索結果にアバター、表示名、ユーザー名を含める
  - _Requirements: 7.5, 7.6_

- [x] 2.8 プッシュ通知APIを実装する
  - `sendCelebrationPushNotification`関数を実装する
  - `sendFollowPushNotification`関数を実装する
  - `social_notifications_enabled`設定のチェックを実装する
  - _Requirements: 6.6, 6.7_

### UIコンポーネント

- [x] 3. コンポーネントの実装
- [x] 3.1 ソーシャルフィードタブを実装する
  - フォロー中ユーザーの達成・共有投稿一覧を表示する
  - 無限スクロール（TanStack Query useInfiniteQuery）を実装する
  - Supabase Realtimeで新しい達成をリアルタイム受信する
  - ユーザー検索とフォロー統計セクションをヘッダーに配置する
  - 空状態（フォロー中のユーザーがいない場合）の表示を実装する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 3.2 フィードアイテムのお祝い機能を実装する
  - フィードアイテムタップでお祝いを送信する
  - パーティクルエフェクト（12個の色付き粒子）を表示する
  - お祝い済みアイテムの視覚的区別（色変更、ボーダー変更）を実装する
  - お祝い取消機能を実装する
  - _Requirements: 5.1, 5.2, 5.3, 5.5_

- [x] 3.3 フォローボタンを実装する
  - フォロー/アンフォロー状態の切替を実装する
  - 楽観的更新（即座にUI反映）を実装する
  - ローディング状態の表示を実装する
  - _Requirements: 2.1, 2.4_

- [x] 3.4 ユーザー検索UIを実装する
  - 検索入力フィールドを実装する
  - 検索結果のドロップダウン表示を実装する
  - 検索結果からのフォロー機能を統合する
  - _Requirements: 7.5, 7.6_

- [x] 3.5 ソーシャル通知タブを実装する
  - お祝い・フォロー通知の一覧を表示する
  - 未読通知数のバッジ表示を実装する
  - 通知タップで既読マークを付ける
  - 通知の送信者情報（アバター、表示名、ユーザー名）を表示する
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 3.6 フォロー/フォロワー一覧を実装する
  - Drawerでフォロー中/フォロワーリストを表示する
  - タブ切替（フォロー中/フォロワー）を実装する
  - 各ユーザーにフォローボタンを配置する
  - _Requirements: 2.5_

- [x] 3.7 フォロー統計セクションを実装する
  - 自分のフォロー数・フォロワー数を表示する
  - タップでフォロー/フォロワー一覧を開く
  - _Requirements: 2.5, 2.6_

- [x] 3.8 プロフィール編集フォームを実装する
  - 表示名の編集機能を実装する
  - ユーザー名の編集機能を実装する
  - ユーザー名のリアルタイム重複チェックを実装する
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

### 統合

- [x] 4. 既存機能との統合
- [x] 4.1 エントリーフォームへの共有トグルを統合する
  - 「フォロワーに共有」トグルスイッチを追加する
  - 投稿作成時のis_sharedフラグ保存を実装する
  - 編集時の共有状態維持・変更を実装する
  - _Requirements: 1.1, 1.3, 1.4_

- [x] 4.2 マイページへのソーシャル機能を統合する
  - 「プロフィール」「みんな」「通知」の3タブ構成を実装する
  - 未読通知数のバッジ表示を実装する
  - 通知設定セクションにソーシャル通知設定を追加する
  - _Requirements: 6.7_

- [x] 4.3 型定義・定数の整備を行う
  - `types.ts`にソーシャル関連の型定義を追加する
  - `constants.ts`に達成閾値・ページネーション設定を追加する
  - `query-keys.ts`にソーシャル関連のqueryKeyを追加する
  - _Requirements: 全般_
