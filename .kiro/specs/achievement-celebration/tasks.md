# Implementation Plan

## Task Overview

投稿成功時のアチーブメント達成演出機能を実装する。達成レベル（1-3）に応じたパーティクルエフェクトとバイブレーションフィードバックを提供し、継続への報酬体験を強化する。

---

## Tasks

- [x] 1. 達成レベル判定ユーティリティを実装する
  - 達成タイプ（streak_days, daily_posts, total_posts, shared_entry）と閾値からレベル（1, 2, 3）を導出する関数を作成
  - 継続3日をLevel 1、継続7/14/21日をLevel 2、継続30日以上をLevel 3として判定
  - 未定義の閾値や新規達成タイプにはデフォルトでLevel 1を返却
  - 既存の達成閾値定数を活用し、新規カラム追加は行わない
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 2. バイブレーションフィードバック機能を実装する
- [x] 2.1 (P) Vibration APIの安全なラッパーフックを作成する
  - デバイスがVibration APIをサポートしているか確認する機能
  - 達成レベルに応じた振動パターンを定義（Level 1: 100ms、Level 2: 100-50-100ms、Level 3: 100-50を3回繰り返し）
  - ドキュメントが非表示状態の場合は振動をスキップ
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 3. 達成パーティクルエフェクトを実装する
- [x] 3.1 (P) レベル別パーティクル設定を定義する
  - Level 1は12個のパーティクルを1波、Level 2は16個を2波、Level 3は24個を3波で表示
  - 各波の間隔は200ミリ秒で断続的に放射状に表示
  - パーティクルはアクセントカラー（accent-400）で表示
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 3.2 達成パーティクルエフェクトコンポーネントを作成する
  - 達成レベルを受け取り、対応するパーティクル演出を表示
  - GPUアクセラレーションを使用して60FPSで滑らかに動作させる
  - アニメーション完了後に不要なDOM要素をクリーンアップ
  - prefers-reduced-motion設定が有効な場合はアニメーションを無効化し、即座に完了コールバックを呼び出す
  - 3.1の設定に依存
  - _Requirements: 5.1, 5.2, 5.3, 5.5_

- [x] 4. エントリ作成の戻り値に達成情報を含める
  - 投稿成功時に新規達成したアチーブメント情報（タイプ、閾値、レベル）を戻り値に追加
  - 新規達成がない場合は空配列を返却
  - 達成情報の取得に失敗した場合でもエントリ作成は成功として扱い、達成情報はnullとして返却
  - 達成レベル判定ユーティリティ（タスク1）を使用してレベルを付与
  - タスク1に依存
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 5. 成功オーバーレイに達成演出を統合する
  - チェックマークアニメーション完了後にパーティクルエフェクトを表示開始
  - 複数の達成がある場合は最も高いレベルのエフェクトを採用
  - 新規達成がない場合は従来どおりチェックマークのみ表示
  - 達成メッセージ（例:「継続7日達成！」）をオーバーレイに表示
  - パーティクルエフェクト表示中はオーバーレイを閉じない
  - スクリーンリーダー向けにaria-live="polite"で達成通知を伝える
  - バイブレーションフックを呼び出して触覚フィードバックを提供
  - タスク2、3、4に依存
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 5.4_

- [x] 6. 統合テストを実装する
- [x] 6.1 (P) 達成レベル判定のユニットテストを作成する
  - 各達成タイプと閾値の組み合わせで正しいレベルが返却されることを検証
  - 未定義の閾値でLevel 1が返却されることを検証
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 6.2 (P) バイブレーションフックのユニットテストを作成する
  - サポート有無の確認が正しく動作することを検証
  - 各レベルで正しい振動パターンが実行されることを検証
  - 未サポートデバイスでエラーが発生しないことを検証
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 6.3 エントリ作成と成功オーバーレイの統合テストを作成する
  - 投稿成功時に達成情報が正しく返却されることを検証
  - 達成チェック失敗時もエントリ作成が成功することを検証
  - 成功オーバーレイで達成演出が表示されることを検証
  - タスク6.1, 6.2に依存しない（並列可能だが統合テストとしてタスク5完了後に実行）
  - _Requirements: 1.1, 1.2, 1.3, 4.1, 4.2, 4.3, 4.4_

- [x] 6.4 (P) パーティクルエフェクトとアクセシビリティのテストを作成する
  - 各レベルで正しい数のパーティクルが表示されることを検証
  - reduced-motion設定時にアニメーションが無効化されることを検証
  - アニメーション完了後にDOM要素がクリーンアップされることを検証
  - MVP後に詳細なビジュアルテストとして追加可能
  - _Requirements: 2.1, 2.2, 2.3, 5.1, 5.3, 5.5_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1. 達成検出と戻り値拡張 (1.1-1.4) | 4, 6.3 |
| 2. パーティクルエフェクト設定 (2.1-2.5) | 3.1, 3.2, 6.4 |
| 3. バイブレーションフィードバック (3.1-3.4) | 2.1, 6.2 |
| 4. SuccessOverlayへの統合 (4.1-4.5) | 5, 6.3 |
| 5. パフォーマンスとアクセシビリティ (5.1-5.5) | 3.2, 5, 6.4 |
| 6. 達成レベル定義 (6.1-6.4) | 1, 6.1 |
