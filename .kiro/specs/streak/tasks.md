# Implementation Plan

## タスク一覧

- [ ] 1. データベーススキーマの作成
- [ ] 1.1 ストリークテーブルを作成する
  - ユーザーごとの継続記録データを保存するテーブルを定義する
  - current_streak、longest_streak、last_entry_dateカラムを含める
  - ほつれ関連カラム（hotsure_remaining、hotsure_used_dates）を含める
  - 適切な制約（CHECK制約、DEFAULT値）を設定する
  - last_entry_dateに対するインデックスを作成する
  - _Requirements: 1.1, 1.2, 1.3, 3.1, 3.2, 4.4, 5.2, 5.3, 5.4, 5.5_

- [ ] 1.2 バッチログテーブルを作成する
  - 日次・週次バッチ処理の実行履歴を記録するテーブルを定義する
  - job_name、executed_at、処理件数、エラー件数を含める
  - 詳細情報をJSONBで格納できるようにする
  - _Requirements: 7.5, 4.5_

- [ ] 1.3 Row Level Securityポリシーを設定する
  - ユーザーが自身のストリーク情報のみ参照・更新できるようにする
  - service_roleによる全アクセスを許可する
  - _Requirements: 6.3_

- [ ] 2. 新規ユーザー初期化機能の実装
  - auth.usersへの新規登録時にストリークレコードを自動作成するトリガーを実装する
  - 初期値としてcurrent_streak=0、longest_streak=0を設定する
  - 初期値としてhotsure_remaining=2、hotsure_used_dates=空配列を設定する
  - SECURITY DEFINER権限でトリガー関数を作成する
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 3. ストリークサービスの実装
- [ ] 3.1 (P) ストリーク情報取得機能を実装する
  - 認証済みユーザーの現在のストリーク状態を取得する機能を作成する
  - current_streak、longest_streak、last_entry_date、hotsure_remaining、hotsure_used_countを返却する
  - レコードが存在しない場合は初期値で作成して返却する
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 3.2 記録作成時のストリーク更新機能を実装する
  - その日初回の記録作成時にcurrent_streakを1増加させる機能を作成する
  - last_entry_dateを当日の日付に更新する
  - current_streakがlongest_streakを超えた場合にlongest_streakを更新する
  - 同日2回目以降の記録では更新しない
  - 日付判定はJST（毎日0:00切り替え）で行う
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 3.3 ストリーク途切れ処理機能を実装する
  - current_streakを0にリセットする機能を作成する
  - longest_streakの値は維持する
  - エラー発生時はログに記録しデータを変更しない
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 3.4 (P) 指定日の記録有無確認機能を実装する
  - 特定の日付にユーザーの記録が存在するかを確認する機能を作成する
  - 日次バッチ処理で前日の記録有無判定に使用する
  - _Requirements: 1.4, 7.2_

- [ ] 4. ほつれサービスの実装
- [ ] 4.1 ほつれ自動消費機能を実装する
  - hotsure_remainingが1以上の場合に1減少させる機能を作成する
  - 消費日をhotsure_used_dates配列に追加する
  - 消費時にcurrent_streakを維持する（途切れさせない）
  - hotsure_remainingが0の場合は消費せずに失敗を返す
  - ユーザー操作なしで自動実行される
  - 同時実行による二重消費を防止する（FOR UPDATEで保護）
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 4.2 ほつれ週次リセット機能を実装する
  - hotsure_remainingを2にリセットする機能を作成する
  - hotsure_used_dates配列をクリアする
  - リセット前の残数に関わらず一律2個に設定する（繰り越しなし）
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 4.3 (P) ほつれ利用可否確認機能を実装する
  - 現在のhotsure_remainingが1以上かを確認する機能を作成する
  - _Requirements: 3.4_

- [ ] 5. 日次バッチ処理の実装
- [ ] 5.1 日次ストリーク判定処理を実装する
  - 毎日0:00（JST）に実行される処理を作成する
  - 前日に記録のない全ユーザーを対象とする
  - 記録なし且つほつれ利用可能な場合はほつれを自動消費する
  - 記録なし且つほつれ利用不可の場合はストリークを途切れさせる
  - 処理結果をバッチログに記録する
  - 個別ユーザーでエラーが発生した場合はスキップして継続し、エラーを記録する
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

- [ ] 5.2 pg_cronジョブを登録する
  - UTC 15:00（JST 0:00）に日次処理を実行するジョブを設定する
  - 二重実行防止のため処理日付をログに記録する
  - _Requirements: 7.1_

- [ ] 6. 週次バッチ処理の実装
- [ ] 6.1 週次ほつれリセット処理を実装する
  - 毎週月曜0:00（JST）に実行される処理を作成する
  - 全ユーザーのほつれを一括でリセットする
  - 処理結果をバッチログに記録する
  - エラー発生時はリトライ処理をスケジュールする
  - _Requirements: 4.1, 4.2, 4.3, 4.5_

- [ ] 6.2 pg_cronジョブを登録する
  - UTC 15:00 月曜日（JST 月曜0:00）に週次処理を実行するジョブを設定する
  - _Requirements: 4.1_

- [ ] 7. ストリークAPIの実装
- [ ] 7.1 ストリーク情報取得エンドポイントを実装する
  - 認証済みユーザーの現在のストリーク状態を返却するAPIを作成する
  - 未認証リクエストには401エラーを返す
  - _Requirements: 6.1, 6.2, 6.3_

- [ ] 7.2 ストリーク更新エンドポイントを実装する
  - 記録作成時にストリークを更新するAPIを作成する
  - 不正な日付形式には400エラーを返す
  - 未認証リクエストには401エラーを返す
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 8. 統合テストの実装
- [ ] 8.1 (P) ストリーク計算のテストを実装する
  - 初回記録時のストリーク増加を検証する
  - 同日2回目の記録でストリークが増加しないことを検証する
  - longest_streakの更新を検証する
  - 日付境界（JST 0:00前後）での動作を検証する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 8.2 (P) ほつれ自動消費のテストを実装する
  - 記録なし日にほつれが自動消費されることを検証する
  - 消費日がhotsure_used_datesに追加されることを検証する
  - ほつれ消費時にcurrent_streakが維持されることを検証する
  - ほつれ残数0の場合にストリークが途切れることを検証する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 8.3 (P) 週次リセットのテストを実装する
  - 月曜0:00にほつれが2個にリセットされることを検証する
  - hotsure_used_datesがクリアされることを検証する
  - 繰り越しなしの動作を検証する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 8.4 新規ユーザー初期化のテストを実装する
  - ユーザー登録時にストリークレコードが作成されることを検証する
  - 初期値が正しく設定されることを検証する
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_
