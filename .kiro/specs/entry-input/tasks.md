# Implementation Plan

## タスク一覧

- [ ] 1. データベース基盤の構築
- [ ] 1.1 entriesテーブルとRLSポリシーを作成する
  - Supabaseマイグレーションでentriesテーブルを定義（id, user_id, content, image_url, is_public, is_deleted, created_at, updated_at）
  - is_deletedとis_publicのデフォルト値をfalseに設定
  - user_idとcreated_atの複合インデックスを作成（is_deleted=falseでフィルタ）
  - JST日付インデックスを作成（日次カウント用）
  - RLSポリシーを設定（所有者のみ読み取り・作成・更新可能、is_deleted=falseのみ表示）
  - _Requirements: 7.1, 7.4, 7.5_

- [ ] 1.2 (P) Supabase Storageバケットを設定する
  - entry-imagesバケットをprivateアクセスで作成
  - パス構造を{user_id}/{timestamp}_{random}.webpで設計
  - RLSによるアクセス制御を設定
  - _Requirements: 2.6_

- [ ] 2. ロジック層の実装
- [ ] 2.1 (P) 下書き自動保存機能を実装する
  - ローカルストレージへの保存・読み込み・削除機能を作成
  - テキストコンテンツと画像プレビュー（Base64）を含むデータ構造を定義
  - 保存時刻のタイムスタンプを付与
  - SSR環境での安全な動作を確保（クライアントサイドのみで実行）
  - 容量超過時のエラーハンドリングを実装
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 2.2 (P) 投稿・画像の日次制限チェック機能を実装する
  - 1日の投稿件数を取得するクエリを作成（JST 0:00基準）
  - 1日の画像アップロード件数を取得するクエリを作成（JST 0:00基準）
  - 投稿上限20件、画像上限5枚の制限値を定義
  - 現在の使用状況と残数を返却する構造を設計
  - _Requirements: 5.1, 5.3, 2.5_

- [ ] 2.3 (P) 画像圧縮・アップロード機能を実装する
  - browser-image-compressionを使用した200KB以下への圧縮処理を作成
  - WebP形式への変換設定（maxSizeMB: 0.2, maxWidthOrHeight: 1920）
  - 圧縮進捗のコールバック対応
  - Web Workerを使用したメインスレッド非ブロック処理
  - 一意なファイル名生成（user_id + timestamp + random）
  - Supabase Storageへのアップロード処理と公開URL取得
  - 対応画像形式の検証（JPEG, PNG, WebP, GIF）
  - _Requirements: 2.2, 2.6_

- [ ] 2.4 エントリのCRUD操作を実装する
  - 新規投稿作成機能（content, imageUrl を受け取りentriesテーブルにINSERT）
  - 絵文字1文字を有効な入力として受け付け、空白のみは拒否する検証
  - 記録の取得機能（IDによる単一取得、所有者確認）
  - 記録の更新機能（content, imageUrlの上書き、updated_atを自動更新）
  - 24時間編集制限の判定機能（created_atからの経過時間チェック）
  - 論理削除機能（is_deletedをtrueに設定）
  - _Requirements: 1.3, 4.3, 4.4, 4.5, 6.2, 6.3, 7.2, 7.3_
  - _依存: 2.2（制限チェック）、2.3（画像アップロード）_

- [ ] 3. UIコンポーネントの実装
- [ ] 3.1 画像添付コンポーネントを作成する
  - ファイル選択インターフェース（input type="file" accept="image/*"）
  - 1投稿1枚の制限をUIで強制
  - 圧縮進捗のスピナー表示
  - 圧縮完了後のプレビュー表示（元サイズと圧縮後サイズの表示）
  - 添付画像の削除機能
  - 1日5枚制限の事前チェックとエラーメッセージ表示
  - _Requirements: 2.1, 2.3, 2.4, 2.5_
  - _依存: 2.2、2.3_

- [ ] 3.2 入力/編集フォームコンポーネントを作成する
  - 画面全体を使った集中モードの入力エリアを実装
  - プレーンテキスト入力のtextareaを作成（文字数カウンター非表示）
  - textareaのauto-resize機能を実装
  - 新規作成モードと編集モードの両対応（propsで切り替え）
  - 画像添付コンポーネントの統合
  - 送信ボタンの実装（2タップ完了を実現）
  - 送信中の二重送信防止（ボタン無効化）
  - 下書き自動保存の統合（300msデバウンス）
  - 下書き復元時の既存データとの衝突処理
  - 投稿制限エラー（20件/日）のメッセージ表示
  - 編集期限切れエラー（24時間）のメッセージ表示
  - 削除確認ダイアログの表示機能
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 5.2, 6.1_
  - _依存: 2.1、2.4、3.1_

- [ ] 4. ページの実装
- [ ] 4.1 新規入力ページを作成する
  - /newルートのServer Componentを作成
  - 認証状態の確認と未ログイン時の/loginへのリダイレクト
  - EntryFormコンポーネントを新規作成モードで埋め込み
  - 投稿完了後のリダイレクト処理（タイムラインまたは成功通知）
  - _Requirements: 1.1, 1.4_
  - _依存: 3.2_

- [ ] 4.2 編集ページを作成する
  - /edit/[id]ルートのServer Componentを作成
  - URLパラメータからエントリIDを取得し、既存記録をフェッチ
  - 存在しないIDまたは他ユーザーの記録は404表示
  - 24時間編集制限のサーバーサイドチェック（超過時はエラー画面）
  - EntryFormコンポーネントを編集モードで埋め込み（既存データを初期値として渡す）
  - 編集完了後のリダイレクト処理
  - _Requirements: 4.1, 4.2_
  - _依存: 3.2_

- [ ] 5. 統合テストと検証
- [ ] 5.1 新規投稿フローの統合テストを実施する
  - フォーム入力から送信、DB保存までの一連の動作確認
  - 画像添付フロー（選択、圧縮、アップロード、URL保存）の検証
  - 下書き自動保存・復元機能の動作確認
  - 投稿制限（20件/日）到達時のエラー表示確認
  - 画像制限（5枚/日）到達時のエラー表示確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 3.1, 3.2, 3.3, 3.4, 5.1, 5.2, 5.3_

- [ ] 5.2 編集・削除フローの統合テストを実施する
  - 既存記録の編集と保存の動作確認
  - 24時間編集制限の検証（境界値テスト）
  - updated_atタイムスタンプ更新の確認
  - 論理削除と表示非表示の動作確認
  - 削除確認ダイアログの動作確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 6.1, 6.2, 6.3_
